---
title: 文件上传
toc: false
date: 2021-03-24 15:56:16
description: 文件上传
tags: Web安全
categories: Web安全
---

## 0x01 前端验证绕过

- 前端校验 = 没有校验
- 将一句话木马文件后缀改成可以通过的文件类型
- 用Brup抓包修改后缀为.php

## 0x02 Content-Type方式绕过

- 将一句话木马文件后缀改成可以通过的文件类型

- 用Brup抓包修改Content-Type为可以通过的文件类型

- - 可以通过上传可以通过的文件查看相应的格式

## 0x03 黑名单绕过

- 不允许上传asp,aspx,php,jsp后缀文件

- 尝试改成解析后一样作用的后缀上传

- - jsp jspx jspf等
  - asp asa cer aspx等
  - php phtml php3 php4等
  - exe exee等

## 0x04 .htaccess文件绕过

- 将所有解析后作用相同的后缀全部加入了黑名单

- 超文本入口(.htaccess)，也被称为分布式配置文件,Apache中存在，但是默认关闭

- - AddType application/x-http-php .jpg 代表jpg文件会被当成php文件执行

## 0x05 后缀大小写绕过

- 将一句话木马文件后缀改成可以通过的文件类型

- 将一句话木马文件后缀改成相应的大小写后缀

- - PHp等

## 0x06 文件后缀(空)绕过

- 大小写被强制转换成小写
- 将一句话木马文件后缀改成可以通过的文件类型
- 将一句话木马文件后缀后面加一个空格

## 0x07 文件后缀(点)绕过

- 文件后缀的前后空格被强制删除
- 将一句话木马文件后缀改成可以通过的文件类型
- 将一句话木马文件后缀后面加一个点

## 0x08 Windows文件流绕过(::$DATA)

- 文件后缀末尾的点被强行删除
- 将一句话木马文件后缀改成可以通过的文件类型
- 将一句话木马文件后缀后面加::$DATA

## 0x09 构造文件后缀绕过

- 文件后缀末尾不允许加::$DATA
- 将一句话木马文件后缀改成可以通过的文件类型
- 将一句话木马文件后缀后面加点空点

## 0x10 双写文件后缀绕过

- 设置str_ireplace函数将php替换成空格
- 将一句话木马文件后缀改成可以通过的文件类型
- 将一句话木马文件后缀修改成为pphphp

## 0x11 %00截断绕过(PHP5.3以下可用)

### GET传参

- 将一句话木马文件后缀改成可以通过的文件类型
- 用Brup抓包，在上传路径/upload/后加上1.php%00将白名单机制加上的东西给截断不执行

### POST传参

- 将一句话木马文件后缀改成可以通过的文件类型
- 用Brup抓包，在上传路径/upload/后加上1.phpa，a的16进制是61，在Hex中找到他将他改成%00对应的00进行截断

## 0x12 图片马绕过

- 检测文件内的内容是不是图片，不是就不给上传
- 将一张图片和一个一句话木马使用`copy 1.jpg/b + 1.txt 123.jpg` 命令合成一张图片马

## 0x13 getimagesize图片类型绕过

- 上传正常类型的图片查看是否能够正常上传
- 换个图片类型进行图片马制作上传

## 0x14 php_exif模块图片类型绕过

- 上同

## 0x15 二次渲染绕过

- 发现上传上去的图片和下载下来的图片不一样时，说明可能进行了二次渲染
- 使用gif文件制作图片马，将图片用Hex打开，从第三行开始输入一句话木马

## 0x16 move_uploaded_file()截断

- 同00截断，只不过00截断截的是路径，而这个截的是图片名字

- 将图片名截断

- - 1.phpa.jpg使用Hex将a的61改成00

## 0x17 条件竞争绕过

- 先上传再检测才有用
- 就算上传成功也会在一瞬间被删除，所以用到了`file_put_contents` 函数
- file_put_contents('1.php','<?php eval($REQUEST[8]); ?>')
- 利用Brup跑包访问上传了图片马并加上上一条函数作为参数的网站，访问到的一瞬间会执行`file_put_contents` 函数在服务器中写入一句话木马文件1.php

## 0x18 IIS6.0解析漏洞

### 一

- IIS6.0在应用程序扩展中默认设置了.asa .cer .cdx都会调用asp.dll
- 利用asp一句话木马文件1.cer制作图片马
- 利用Brup抓包修改文件后缀名为.cer上传

### 二

- 针对IIS6.0有效

- IIS6.0在处理含有特殊符号的文件路径时会出现逻辑错误，造成文件解析漏洞，两种不同的利用方式都会被当作asp进行解析

- - test.asp;.jpg
  - test.asp/123.jpg

- 上传文件时直接修改文件名后缀

### 三

- 设置了上传存储的文件夹名为a.asp，所有上传到这个文件夹的文件都会被当做asp文件解析执行

## 0x19 CGI解析漏洞

- 仅用于PHP
- IIS7.5最多 Nginx IIS高版本都会有
- 随便上传一张图片马，访问图片网址后加上/.php就会被执行一句话木马文件